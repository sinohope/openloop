openapi: 3.0.0
info:
  title: OpenLoop API
  version: 1.2.0
  description: 
    $ref: description.md
tags:
  - name: Custody->Exchange
    description: Custody calls Exchange
  - name: Exchange->Custody
    description: Exchange calls Custody
  - name: Exchange->E-Custody
    description: Exchange's business system calls the mpc custody service (which is run by the exchange) internally
  - name: E-Custody->Exchange
    description: The mpc custody service (which is run by the exchange) calls Exchange's business system internally
paths:
  /exchange/v1/connect:
    post:
      tags:
        - Custody->Exchange
      description: Connect CVA account with MEA account
      summary: /exchange/v1/connect
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                collateralId:
                  type: string
                  description: Unique identifier for the CVA account
                exchangeAccountId:
                  type: string
                  description: Unique identifier for the MEA account to be bound, API KEY
              required:
                - collateralId
                - exchangeAccountId
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: boolean
                    enum: [false,true]
                    description: Binding status, False/True (failed/success)
                  rejectReason:
                    type: string
                    nullable: true
                    description: Reason for rejection if binding is denied by the exchange; can be null if the validation passes
                required:
                  - status

  /exchange/v1/address:
    post:
      tags:
        - Custody->Exchange
      description: Notify exchange to add new addresses for the CVA account
      summary: /exchange/v1/address
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                requestId:
                  type: string
                  description: Identifier for this binding request
                collateralId:
                  type: string
                  description: Unique identifier for the CVA account
                assets:
                  type: array
                  items:
                    type: object
                    properties:
                      currency:
                        type: string
                        description: Currency identifier defined by the exchange
                      network:
                        type: string
                        description: Chain identifier defined by the exchange
                      assetId:
                        type: string
                        description: Asset identifier defined by SinoHope (different asset identifiers for the same currency on different chains, e.g., USDT_ETH, USDT_TRON)
                      address:
                        type: string
                        description: Address allocated by SinoHope for the user's CVA account
                      settlementNetwork:
                        type: string
                        description: the settlement network of this asset.
                      tag:
                        type: string
                        nullable: true
                        description: Tag allocated by SinoHope for the user's CVA account
                    required:
                      - currency
                      - network
                      - assetId
                      - address
                      - settlementNetwork
              required:
                - requestId
                - collateralId
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  received:
                    type: number
                    example: 0
                    description: Address reception status,enum, 0 asynchronously processing, 1 Failed, 2 Success.
                required:
                  - received

  /exchange/v1/address/status:
    get:
      tags:
        - Custody->Exchange
      description: Check the status of the address addition request
      summary: /exchange/v1/address/status
      parameters:
        - name: requestId
          in: query
          required: true
          description: Identifier for this binding request
          schema:
            type: string
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: boolean
                    description: Address addition status, False/True (failed/success)
                required:
                  - status

  /exchange/v1/mpc/pubkey:
    post:
      tags:
        - Custody->Exchange
      description: Notify exchange to add relationship between CVA account and the root mpc public key (If the Exchange keeps one mpc key share)
      summary: /exchange/v1/mpc/pubkey
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                collateralId:
                  type: string
                  description: Unique identifier for the CVA account
                cmrkPK:
                  type: string
                  description: The public key of the CVA's root mpc key
              required:
                - collateralId
                - cmrkPK
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: boolean
                    description: Status of setting the related public key, False/True (failed/success)
                required:
                  - status

  /exchange/v1/settlement/network:
    post:
      tags:
        - Custody->Exchange
      description: Set the default settlement network for CVA addresses (multi-chain scenario)
      summary: /exchange/v1/settlement/network
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                collateralId:
                  type: string
                  description: Unique identifier for the CVA account
                assetId:
                  type: string
                  description: SinoHope-defined asset identifier
                perferedNetwork:
                  type: string
                  description: Default settlement network for the CVA account, specified by the user on SinoHope side (previously confirmed with the exchange)
              required:
                - collateralId
                - assetId
                - perferedNetwork
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: boolean
                    description: Status of setting the preferred network, False/True (failed/success)
                required:
                  - status

  /exchange/v1/settlement/list:
    post:
      tags:
        - Custody->Exchange
      description: Request settlement details from the exchange for user-initiated settlements
      summary: /exchange/v1/settlement/list
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                collateralId:
                  type: string
                  description: Unique identifier for the CVA account
                settlementId:
                  type: string
                  description: Unique identifier for a settlement batch
                assetId:
                  type: string
                  nullable: true
                  description: For user-initiated single-currency settlements
              required:
                - collateralId
                - settlementId
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  settlementId_ex:
                    type: string
                    description: Exchange-side unique identifier for the settlement batch
                  to_exchange:
                    type: array
                    items:
                      type: object
                      properties:
                        assetid:
                          type: string
                          description: SinoHope's asset identifier (for multi-chain scenarios, the exchange needs to split the details based on the CVA account balance)
                        amount:
                          type: string
                          description: Settlement amount
                        toAddress:
                          type: string
                          description: Exchange's receiving address
                        toTag:
                          type: string
                          nullable: true
                          description: Exchange's receiving address tag
                      required:
                        - assetid
                        - amount
                        - toAddress
                  to_collateral:
                    type: array
                    items:
                      type: object
                      properties:
                        assetid:
                          type: string
                          description: SinoHope's asset identifier (for multi-chain scenarios, assets should be merged for settlement based on the user's preferred network)
                        amount:
                          type: string
                          description: Settlement amount
                        toAddress:
                          type: string
                          description: CVA address
                        toTag:
                          type: string
                          nullable: true
                          description: CVA address tag
                      required:
                        - assetid
                        - amount
                        - toAddress

  /exchange/v1/settlement/confirm:
    post:
      tags:
        - Custody->Exchange
      description: Notify the exchange to initiate settlement to CVA account after user confirmation
      summary: /exchange/v1/settlement/confirm
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                collateralId:
                  type: string
                  description: Unique identifier for the CVA account
                settlementId:
                  type: string
                  description: Unique identifier for a settlement batch
                assetId:
                  type: string
                  nullable: true
                  description: For user-initiated partial confirmation scenarios
              required:
                - collateralId
                - settlementId
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: boolean
                    description: Settlement initiation status, False/True (failed/success)
                required:
                  - status

  /exchange/v1/settlement/status:
    get:
      tags:
        - Custody->Exchange
      description: Query the settlement progress from SinoHope to the exchange
      summary: /exchange/v1/settlement/status
      parameters:
        - name: settlementId
          in: query
          required: true
          schema:
            type: string
          description: Unique identifier for a settlement batch
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        assetid:
                          type: string
                          description: Asset list transferred from the exchange to CVA
                        status:
                          type: string
                          description: Settlement status, enumeration to be determined
                        txHash:
                          type: string
                          nullable: true
                          description: Transaction hash, if the transfer is completed

  /exchange/v1/settlement/finish:
    post:
      tags:
        - Custody->Exchange
      description: Notify the exchange after SinoHope settlement is completed
      summary: /exchange/v1/settlement/finish
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                settlementId:
                  type: string
                  description: Unique identifier for a settlement batch
                data:
                  type: array
                  items:
                    type: object
                    properties:
                      assetid:
                        type: string
                        description: Asset list transferred from CVA account to the exchange
                      status:
                        type: string
                        description: Settlement status, enumeration to be determined
                      txHash:
                        type: string
                        nullable: true
                        description: Transaction hash, if the transfer is completed
              required:
                - settlementId
                - data
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: boolean
                    description: Status of the settlement finish notification, False/True (failed/success)
                required:
                  - status

  /exchange/v1/withdraw:
    post:
      tags:
        - Custody->Exchange
      description: Request authorization from the exchange after the user initiates a withdrawal from the CVA account
      summary: /exchange/v1/withdraw
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                collateralId:
                  type: string
                  description: Unique identifier for the CVA account
                txId:
                  type: string
                  description: Unique identifier for the withdrawal order defined by SinoHope (if the withdrawal fails, the same txId will be used to initiate the withdrawal request)
                assetId:
                  type: string
                  description: SinoHope-defined currency identifier
                amount:
                  type: string
                  description: Withdrawal amount of the user
                fromAddress:
                  type: string
                  description: Specific CVA address (multiple addresses may exist under the same network for a CVA account)
                fromTag:
                  type: string
                  nullable: true
                  description: Tag corresponding to the specific CVA address
                toAddress:
                  type: string
                  description: Withdrawal target address
                toTag:
                  type: string
                  nullable: true
                  description: Withdrawal target address tag
              required:
                - collateralId
                - txId
                - assetId
                - amount
                - fromAddress
                - toAddress
      responses:
        '200':
          description: Successful response
          content:
             application/json:
              schema:
                type: object
                properties:
                  status:
                    type: boolean
                    description: Status of the withdrawal request, False/True (failed/success)
                  rejectReason:
                    type: string
                    nullable: true
                    description: The reject reason if the status is False
                required:
                  - status

  /exchange/v1/mpc/join:
    post:
      tags:
        - Custody->Exchange
      description: Notify the exchange's mpc key share custody service to join an mpc business initiated by user
      summary: /exchange/v1/mpc/join
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                collateralId:
                  type: string
                  description: Unique identifier for the CVA account
                mpcType:
                  type: string
                  enum: ["DKG", "Refresh", "Delete"]
                  example: "Refresh"
                  description: MPC business type, enumeration of "DKG", "Refresh", "Delete"
                userId:
                  type: string
                  description: A data needed for locating the mpc key share
                cryptography:
                  type: string
                  description: Either "ecdsa-secp256k1" or "eddsa-ed25519"
                timeToLive:
                  type: number
                  description: The total TTL of this mpc business
                targetUserId:
                  type: string
                  nullable: true
                  description: The result will be connected to this target user id (null if the mpcType is DKG)
                cmrkPK:
                  type: string
                  nullable: true
                  description: The public key to identifies an mpc key share (null if the mpcType is DKG, otherwise it's required)
                path:
                  type: string
                  nullable: true
                  description: The path to derive the target account.
                signatureX1:
                  type: string
                  nullable: true
                  description: The user's signature to the mpc parameter data, which is signed by the user's mpc key share.(null if the mpcType is DKG, otherwise it's required)
              required:
                - collateralId
                - mpcType
                - userId
                - cryptography
                - timeToLive
      responses:
        '200':
          description: Successful response
          content:
             application/json:
              schema:
                type: object
                properties:
                  status:
                    type: boolean
                    description: Status of the request, False/True (failed/success)
                  failedReason:
                    type: string
                    nullable: true
                    description: The failed reason if the status is False
                required:
                  - status

  /collateral/v1/address/status:
    post:
      tags:
        - Exchange->Custody
      description: Notify SinoHope after the exchange asynchronously processes the added address request
      summary: /collateral/v1/address/status
      security:
        - ApiKeyAuth: []
          ApiSig: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                requestId:
                  type: string
                  description: Identifier for the binding request
              required:
                - requestId
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: boolean
                    description: Status of the address request processing, False/True (failed/success)
                required:
                  - status

  /collateral/v1/settlement:
    post:
      tags:
        - Exchange->Custody
      description: Notify SinoHope of the settlement details list after the exchange initiates a settlement
      summary: /collateral/v1/settlement
      security:
        - ApiKeyAuth: []
          ApiSig: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                settlementId_ex:
                  type: string
                  description: Exchange-side settlement batch identifier
                collateralId:
                  type: string
                  description: Unique identifier for the CVA account
                to_exchange:
                  type: array
                  items:
                    type: object
                    properties:
                      assetid:
                        type: string
                        description: SinoHope asset identifier (for multi-chain scenarios, the exchange needs to split the details based on the balance of the user's CVA address)
                      amount:
                        type: string
                        description: Settlement amount
                      toAddress:
                        type: string
                        description: Exchange receiving address
                      toTag:
                        type: string
                        nullable: true
                        description: Exchange receiving address tag
                to_collateral:
                  type: array
                  items:
                    type: object
                    properties:
                      assetid:
                        type: string
                        description: SinoHope asset identifier (for multi-chain scenarios, the exchange needs to merge the settlement assets based on the user's preferedNetwork field when binding the address)
                      amount:
                        type: string
                        description: Settlement amount
                      toAddress:
                        type: string
                        description: CVA address
                      toTag:
                        type: string
                        nullable: true
                        description: CVA address tag
              required:
                - settlementId_ex
                - collateralId
                - to_exchange
                - to_collateral
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  settlementId:
                    type: string
                    description: Unique identifier for a settlement batch
                required:
                  - settlementId

  /collateral/v1/settlement/tx/build:
    post:
      tags:
        - Exchange->Custody
      description: Build an unsigned transaction acording the settlementId and assetId (the transfer amount will be filled by the user confirmed settlement details)
      summary: /collateral/v1/settlement/tx/build
      security:
        - ApiKeyAuth: []
          ApiSig: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                settlementId:
                  type: string
                  description: Unique identifier for a settlement batch
                assetId:
                  type: string
                  description: SinoHope-defined currency identifier
              required:
                - settlementId
                - assetId
      responses:
        '200':
          description: Successful response
          content:
             application/json:
              schema:
                type: object
                properties:
                  status:
                    type: boolean
                    description: Status of the transaction build, False/True (failed/success)
                  tx:
                    type: object
                    description: Not null if the status is true
                    properties:
                      transactionId:
                        type: string
                        description: A unique identifier of this transaction( not a transaction hash)
                      network:
                        type: string
                        description: the network of this transaction
                      txType:
                        type: string
                        description: Transaction type. Different block chains have different logics, and there may be different transaction types/formats within a same block chain.
                      hashToBeSigned:
                        type: string
                        description: Unsigned transaction hash. Note that this is not the final transaction hash.
                      data:
                        type: object
                        description: Unsigned transaction detail data, which needs to determine the data fields based on network, and txType.
                        properties:
                          field1:
                            type: string
                            description: TODO...
                    required:
                      - transactionId
                      - network
                      - txType
                      - hashToBeSigned
                      - data
                  fromAccount:
                    type: object
                    description: The information about the "from" account of the current transaction. Not null if the status is true.
                    properties:
                      userId:
                        type: string
                        description: A data needed for initiating an mpc signing
                      cmrkPK:
                        type: string
                        description: The public key to identifies an mpc key share
                      path:
                        type: string
                        description: The path to derive the "from" account.
                    required:
                      - userId
                      - cmrkPK
                      - path
                  failedReason:
                    type: string
                    nullable: true
                    description: The failed reason if the status is False
                required:
                  - status

  /collateral/v1/settlement/tx/broadcast:
    post:
      tags:
        - Exchange->Custody
      description: Broadcast a signed transaction
      summary: /collateral/v1/settlement/tx/broadcast
      security:
        - ApiKeyAuth: []
          ApiSig: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                transactionId:
                  type: string
                  description: The unique identifier of the transaction defined by SinoHope
                formattedSigs:
                  type: string
                  description: The final signature formatted acording to the network
              required:
                - transactionId
                - formattedSigs
      responses:
        '200':
          description: Successful response
          content:
             application/json:
              schema:
                type: object
                properties:
                  status:
                    type: boolean
                    description: Status of the broadcast, False/True (failed/success)
                  failedReason:
                    type: string
                    nullable: true
                    description: The failed reason if the status is False
                required:
                  - status


  /collateral/v1/transactions:
    get:
      tags:
        - Exchange->Custody
      description: Query the progress of CVA account withdrawal based on the withdrawal order number initiated by SinoHope
      summary: /collateral/v1/transactions
      security:
        - ApiKeyAuth: []
          ApiSig: []
      parameters:
        - name: txId
          in: query
          required: true
          schema:
            type: string
          description: Unique identifier for the withdrawal order
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    description: Settlement status, enumeration to be determined
                  txHash:
                    type: string
                    nullable: true

  /internal/v1/mpc/start:
    post:
      tags:
        - Exchange->E-Custody
      description: Notify the exchange's mpc key share custody service to initiates an mpc signing
      summary: /internal/v1/mpc/start
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                requestId:
                  type: string
                  description: The unique identifier of this request
                userId:
                  type: string
                  description: A data needed for initiating an mpc signing
                cmrkPK:
                  type: string
                  description: The public key to identifies an mpc key share
                path:
                  type: string
                  description: The path to derive the "from" account.
                mpcType:
                  type: string
                  description: MPC business type, currently it should be "sign"
                network:
                  type: string
                  description: Chain identifier
                cryptography:
                  type: string
                  description: Either "ecdsa-secp256k1" or "eddsa-ed25519", determined by the network
                message:
                  type: string
                  description: The message (unsigned transaction hash) to be signed
                timeToLive:
                  type: number
                  description: The total TTL of this mpc business
                tokenData:
                  type: object
                  description: The token information needed to connect to the SinoHope's mpc-proxy.
                  properties:
                    token:
                      type: string
                      description: The token needed for connecting to the mpc-proxy.
                    TODO:
                      description: To be defined about all the fields
              required:
                - requestId
                - userId
                - cmrkPK
                - path
                - mpcType
                - network
                - cryptography
                - message
                - timeToLive
                - tokenData
      responses:
        '200':
          description: Successful response
          content:
             application/json:
              schema:
                type: object
                properties:
                  status:
                    type: boolean
                    description: Status of the request, False/True (failed/success)
                  failedReason:
                    type: string
                    nullable: true
                    description: The failed reason if the status is False
                required:
                  - status

  /internal/v1/mpc/signature/result:
    post:
      tags:
        - E-Custody->Exchange
      description: Notify the signature result to the exchange
      summary: /internal/v1/mpc/signature/result
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                requestId:
                  type: string
                  description: The request id that this result related to
                r:
                  type: string
                  description: The "r" vaule of the signature, hexadecimal string
                s:
                  type: string
                  description: The "s" vaule of the signature, hexadecimal string
                v:
                  type: number
                  description: The "v" vaule of the signature, either 0 or 1
                formattedSigs:
                  type: string
                  description: The final signature formatted acording to the network
              required:
                - requestId
                - r
                - s
      responses:
        '200':
          description: Successful response
          content:
             application/json:
              schema:
                type: object
                properties:
                  status:
                    type: boolean
                    description: Status of the request, False/True (failed/success)
                  failedReason:
                    type: string
                    nullable: true
                    description: The failed reason if the status is False
                required:
                  - status

  /internal/v1/mpc/join:
    post:
      tags:
        - Exchange->E-Custody
      description: Notify the exchange's mpc key share custody service to join an mpc business initiated by user
      summary: /internal/v1/mpc/join
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                mpcType:
                  type: string
                  description: MPC business type, enumeration of "DKG", "Refresh", "Delete"
                userId:
                  type: string
                  description: A data needed for locating the mpc key share
                cryptography:
                  type: string
                  description: Either "ecdsa-secp256k1" or "eddsa-ed25519"
                timeToLive:
                  type: number
                  example: 1683196746
                  description: The total TTL of this mpc business
                targetUserId:
                  type: string
                  nullable: true
                  description: The result will be connected to this target user id (null if the mpcType is DKG)
                cmrkPK:
                  type: string
                  nullable: true
                  description: The public key to identifies an mpc key share (null if the mpcType is DKG, otherwise it's required)
                path:
                  type: string
                  nullable: true
                  description: The path to derive the target account.
                signatureX1:
                  type: string
                  nullable: true
                  description: The user's signature to the mpc parameter data, which is signed by the user's mpc key share.(null if the mpcType is DKG, otherwise it's required)
                tokenData:
                  type: object
                  description: The token information needed to connect to the SinoHope's mpc-proxy.
                  properties:
                    token:
                      type: string
                      description: The token needed for connecting to the mpc-proxy.
                    TODO:
                      description: To be defined about all the fields
              required:
                - mpcType
                - userId
                - cryptography
                - timeToLive
                - tokenData
      responses:
        '200':
          description: Successful response
          content:
             application/json:
              schema:
                type: object
                properties:
                  status:
                    type: boolean
                    description: Status of the request, False/True (failed/success)
                  failedReason:
                    type: string
                    nullable: true
                    description: The failed reason if the status is False
                required:
                  - status

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: This API key is given to you by SinoHope when onboarding your
        exchange.
    ApiSig:
      type: apiKey
      in: header
      name: X-API-SIG
      description: signature of the request body using the secret_key which is provided by SinoHope when onboarding your exchange.